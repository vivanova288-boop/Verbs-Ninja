<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Verb Ninja</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
<style>
html, body {margin:0; padding:0; overflow:hidden; width:100vw;height:100vh; user-select:none;}
body {
  width:100vw; height:100vh;
  font-family:'Roboto Condensed', Arial, sans-serif;
}

#game-bg {background: url('images/bg.png') center/cover; 
position:fixed;top:0;left:0; 
width:100vw; 
height:100vh;}

#game-canvas {position:absolute;top:0;left:0;width:100vw;height:100vh;display:block;pointer-events:auto;z-index:2;}

/* Стили для контейнера громкости */
.volume-control {
  position: fixed;
  top: 25px;
  right: 25px;
  z-index: 10;
  background: rgba(12, 13, 23, 0.8);
  padding: 10px 15px;
  border-radius: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
  border: 1px solid #fff3;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.volume-control input[type=range] {
  cursor: pointer;
  width: 80px;
  accent-color: #36fa6d;
}

.progress-container 
{position:fixed;top:25px;left:50%;
transform:translateX(-50%);
width:400px;
height:30px;
background:rgba(255,255,255,0.25);
border-radius:15px;
box-shadow:0 4px 24px 6px #3e2c0b2e;
z-index:5;
overflow:hidden;
border:2px solid #fff7;}

.progress-bar 
{height:100%;width:0;background:linear-gradient(90deg,#36fa6d 10%,#fff700 100%);
border-radius:15px;box-shadow:0 0 12px 2px #3ef866cc;
transition:width .3s cubic-bezier(.6,.5,.4,1.2);}

.progress-bar.miss {background:linear-gradient(90deg,#fd4747 40%,#fdc000 100%)!important; transition:none;}

.status-bar {
  position:fixed;top:65px;left:50%;transform:translateX(-50%);
  color:#fff;
  font-size:1.28rem;
  z-index:9;font-family:'Roboto Condensed', Arial, sans-serif;
  background:rgba(12,13,23,0.88);
  padding:7px 26px;
  border-radius:17px;
  box-shadow:0 0 12px #0009;
  letter-spacing:.5px;
}

.finish-message {
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.7);color:#fff;
  font-size:2.2rem;
  padding:40px 60px;border-radius:30px;z-index:100;
  display:none;box-shadow:0 8px 44px #0d0e16;text-align:center;
  font-family:"Roboto Condensed", Arial, sans-serif;
}

.finish-message button {margin-top:18px;
 font-size:1.3rem;
 background:#fff7;
 border:none;
 border-radius:15px;
 padding:13px 33px; 
 font-family:"Roboto Condensed", Arial, sans-serif;}

.overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
}
.overlay-content {
    position: relative;
    min-width: 360px;
    padding: 30px 40px 30px;
    border-radius: 20px;
    background: rgba(5,5,5,0.85);
    border: 3px solid rgba(180,130,255,1);
    box-shadow:
        0 0 25px rgba(180,130,255,1),
        0 0 80px rgba(0,0,0,1);
    text-align: center;
    color: #ffeeb3;
    font-family: "Roboto Condensed", Arial, sans-serif;
}
.overlay h1 {
    margin-bottom: 20px;
    font-size: 36px;
    letter-spacing: 2px;
    text-transform: uppercase;
    text-shadow: 0 0 14px rgba(190,140,255,0.95);
    font-family: "Roboto Condensed", Arial, sans-serif;
}
.overlay p {
    margin-bottom: 20px;
    font-size: 18px;
}
.overlay button {
    margin-top: 5px;
    padding: 10px 25px;
    font-size: 18px;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #d6b3ff, #974dff);
    color: #1b0a33;
    font-weight: 700;
    box-shadow:
        0 0 12px rgba(190,140,255,0.95),
        0 0 20px rgba(190,140,255,0.75);
    font-family: "Roboto Condensed", Arial, sans-serif;
    transition: transform 0.1s, box-shadow 0.1s;
}
.overlay button:hover {
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 0 18px rgba(190,140,255,1);
}
.overlay button:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 0 0 8px rgba(190,140,255,0.7);
}

#countdown {
  position:fixed;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  z-index:300;
  pointer-events:none;
  font-family:'Roboto Condensed', Arial, sans-serif;
  font-size: 140px;
  color: #388aa8;
  text-shadow:
    0 0 35px #ffda6c,
    0 0 90px #ffe14bcc,
    0 0 16px #fff2,
    0 0 2px #fff6;
  font-weight: 700;
  display: none;
  text-align:center;
  letter-spacing:5px;
  animation: countdown-fade 1s forwards;
}
@keyframes countdown-fade {
  0% { opacity: 1; transform:translate(-50%,-50%) scale(1);}
  65% { opacity: 1;  transform:translate(-50%,-50%) scale(1.18);}
  100%{ opacity: 0;  transform:translate(-50%,-50%) scale(0.7);}
}
</style>
</head>
<body>
<div id="game-bg"></div>

<div class="volume-control">
  <span>Vol</span>
  <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
</div>

<div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
<div class="status-bar" id="status-bar"></div>
<canvas id="game-canvas"></canvas>
<div class="finish-message" id="finish-message"></div>

<div id="start-overlay" class="overlay" style="display:flex;">
    <div class="overlay-content">
        <h1>Verb Ninja</h1>
        <p>
          Click or use the long press to pop the Irregular Verb Balls!
		  Name their 2nd form!<br>
          Avoid Regular Verb Balls!<br>
        </p>
        <button id="start-btn">Play game</button>
    </div>
</div>

<div id="countdown"></div>

<script>
// --- AUDIO ELEMENTS ---
const sfxCorrect = new Audio('1.mp3');
const sfxWrong = new Audio('2.mp3');
const sfxVictory = new Audio('3.mp3');
const sfxGameOver = new Audio('4.mp3');

let currentVolume = 0.5; // Громкость по умолчанию

function playSound(audio) {
    audio.currentTime = 0;
    audio.volume = currentVolume; // Применяем текущую громкость перед проигрыванием
    audio.play().catch(e => console.log("Audio playback blocked"));
}

// Логика бегунка громкости
const volSlider = document.getElementById('volume-slider');
volSlider.oninput = function() {
    currentVolume = this.value;
};

const correctWords = [
  "ride","go","come","buy","have","be","eat","give","meet","take","swim","sleep","think","run","write"
];
const wrongWords  = [
  "jump","visit","cook","hate","love","open","taste","live","listen","wait","bake","close","paint","want","climb"
];

const elementImgs=[
 'images/1.png',
 'images/2.png',
 'images/3.png',
 'images/4.png'
];

const IMG_SIZE=110, PROGRESS_COUNT=correctWords.length, ERROR_LIMIT=4;
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
let _cw=correctWords.slice(), _ww=wrongWords.slice(); shuffle(_cw); shuffle(_ww);

let canvas=document.getElementById('game-canvas'), ctx=canvas.getContext('2d');
function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
resize();window.addEventListener('resize',resize);

let flyingElements=[];
let wordCorrectQ = _cw.map(w=>({word:w,isCorrect:true})),
    wordWrongQ   = _ww.map(w=>({word:w,isCorrect:false}));
let repeatCorrectQueue = [];
let caughtCorrect = {}, progress=0,errors=0,finished=false, gameStarted=false;
let pairWas = "none";
let pairRepeat = 0;
let sliceMode=false,cursorPath=[],sliceEffectTimer=0;
let progressBarRedTimer=0;

function allXSlots(){
 let count=Math.max(2,Math.min(8,Math.floor(window.innerWidth/(IMG_SIZE+30))));
 let margin=35; let spread=Math.floor((canvas.width-2*margin-IMG_SIZE)/(count-1||1));
 let arr=[]; for(let i=0;i<count;i++)arr.push(margin+i*spread); return arr;
}
function freeKeySlots(){
 let busy=flyingElements.filter(e=>!e.sliced).map(e=>e.xSlot),xs=allXSlots(),free=[];
 for(let i=0;i<xs.length;i++)if(busy.indexOf(i)==-1)free.push(i);return free;
}
function nextWordCorrect() {
 return repeatCorrectQueue.length ? repeatCorrectQueue.shift() : (wordCorrectQ.length?wordCorrectQ.shift():null);
}
function nextWordWrong() {
 return wordWrongQ.length?wordWrongQ.shift():null;
}
function trySpawnNew(){
  if(finished||!gameStarted)return;
  let needed = 2 - flyingElements.filter(x=>!x.sliced).length;
  if(needed<=0) return;
  let pattern="cw";
  if(pairWas==="ww"&&pairRepeat>=1){ pattern="cw"; }
  else if(Math.random()<0.22 && wordWrongQ.length>=2) { pattern="ww"; }
  let usedCorrect = null, usedWrong = null;
  if(pattern==="ww"){
    usedWrong=nextWordWrong(); usedWrong&&spawnElementCustomWord(usedWrong);
    usedWrong=nextWordWrong(); usedWrong&&spawnElementCustomWord(usedWrong);
    pairWas="ww"; pairRepeat=pairWas==="ww"?pairRepeat+1:1;
  } else {
    if(Math.random()<.5){
      usedCorrect=nextWordCorrect(); usedCorrect&&spawnElementCustomWord(usedCorrect);
      usedWrong=nextWordWrong();    usedWrong&&spawnElementCustomWord(usedWrong);
    }else{
      usedWrong=nextWordWrong();    usedWrong&&spawnElementCustomWord(usedWrong);
      usedCorrect=nextWordCorrect(); usedCorrect&&spawnElementCustomWord(usedCorrect);
    }
    pairWas="cw"; pairRepeat=0;
  }
}
function spawnElementCustomWord(wordObj){
  if(!wordObj) return;
  let xs=freeKeySlots();
  if(xs.length==0) return;
  let slot=xs[Math.floor(Math.random()*xs.length)];
  let x=allXSlots()[slot], y=canvas.height-IMG_SIZE-2, topY=canvas.height*0.16+Math.random()*canvas.height*0.19;
  let imgSrc=elementImgs[Math.floor(Math.random()*elementImgs.length)];
  let totalTimeUp=220+Math.floor(Math.random()*80), totalTimeDown=250+Math.floor(Math.random()*100);
  flyingElements.push({
    id:Math.random(),x,y,xSlot:slot,phase:'up',t:0,word:wordObj.word,isCorrect:wordObj.isCorrect,imgSrc,
    sliced:false,halfs:null,topY:topY,totalTimeUp,totalTimeDown,startY:y
  });
}
function updateElements(){
 for(let el of flyingElements){
  if(!el.sliced){
   if(el.phase==="up"){
     el.t++;
     let p=el.t/el.totalTimeUp;
     if(p<=1){
       let e=1-(1-p)*(1-p);
       el.y=el.startY-(el.startY-el.topY)*e;
     }else{el.phase="down";el.t=0;el.downStartY=el.y;}
   }else if(el.phase==="down"){
     el.t++;
     let p=el.t/el.totalTimeDown;
     if(p<=1){
       let e=p*p*0.92+0.08*p;
       el.y=el.downStartY+(canvas.height+IMG_SIZE-el.downStartY)*e;
     }else{
      if(el.isCorrect && !caughtCorrect[el.word]){
        repeatCorrectQueue.push({word:el.word,isCorrect:true});
        shuffle(repeatCorrectQueue);
      }
      el.sliced=-1;
      setTimeout(trySpawnNew,200+Math.random()*120);
     }
   }
  }else if(el.halfs)for(let half of el.halfs){
    half.x+=half.vx;half.y+=half.vy;half.vy+=half.ay;half.angle+=half.omega;
    if(half.y>canvas.height+150)half.alpha=0.03;
  }
 }
 flyingElements=flyingElements.filter(el=>el.sliced!==-1&&(!el.sliced||el.halfs[0].alpha>0.01));
}
function drawElements(){
 for(let el of flyingElements){
  if(!el.sliced){
   let img=new Image();img.src=el.imgSrc;ctx.drawImage(img,el.x,el.y,IMG_SIZE,IMG_SIZE);
   ctx.font="bold 26px 'Roboto Condensed', Arial";ctx.strokeStyle="#222a";ctx.lineWidth=7;ctx.textAlign="center";
   ctx.strokeText(el.word,el.x+IMG_SIZE/2,el.y+72);
   ctx.fillStyle="#fff";ctx.shadowColor="#1331ff55";ctx.shadowBlur=6;
   ctx.fillText(el.word,el.x+IMG_SIZE/2,el.y+72);ctx.shadowBlur=0;
  }else if(el.halfs){drawHalf(el.halfs[0]);drawHalf(el.halfs[1]);}
 }
}
function drawHalf(h){
 ctx.save();ctx.globalAlpha=h.alpha;
 ctx.translate(h.x+IMG_SIZE/2,h.y+IMG_SIZE/2);
 ctx.rotate(h.angle);ctx.translate(-(h.x+IMG_SIZE/2),-(h.y+IMG_SIZE/2));
 ctx.beginPath();
 if(h.type==='up')ctx.moveTo(h.x,h.y+IMG_SIZE/2),ctx.lineTo(h.x,h.y),ctx.lineTo(h.x+IMG_SIZE,h.y),ctx.lineTo(h.x+IMG_SIZE,h.y+IMG_SIZE/2);
 else ctx.moveTo(h.x,h.y+IMG_SIZE/2),ctx.lineTo(h.x,h.y+IMG_SIZE),ctx.lineTo(h.x+IMG_SIZE,h.y+IMG_SIZE),ctx.lineTo(h.x+IMG_SIZE,h.y+IMG_SIZE/2);
 ctx.closePath();ctx.save();ctx.clip();
 let img=new window.Image();img.src=h.imgSrc;ctx.drawImage(img,h.x,h.y,IMG_SIZE,IMG_SIZE);
 ctx.font="bold 26px 'Roboto Condensed', Arial";ctx.strokeStyle="#222a";ctx.lineWidth=7;ctx.textAlign="center";
 ctx.strokeText(h.word,h.x+IMG_SIZE/2,h.y+72);
 ctx.fillStyle="#fff";ctx.shadowColor="#1331ff55";ctx.shadowBlur=6;
 ctx.fillText(h.word,h.x+IMG_SIZE/2,h.y+72);ctx.shadowBlur=0;ctx.restore();ctx.restore();
}
function fatLineRectIntersect(x1,y1,x2,y2,rx,ry,rw,rh){
 ry=ry+IMG_SIZE*0.18; rh=IMG_SIZE*0.65;
 return lineRectIntersect(x1,y1,x2,y2,rx,ry,rw,rh);
}
function lineRectIntersect(x1,y1,x2,y2,rx,ry,rw,rh){
 return segI(x1,y1,x2,y2,rx,ry,rx,ry+rh)||
        segI(x1,y1,x2,y2,rx+rw,ry,rx+rw,ry+rh)||
        segI(x1,y1,x2,y2,rx,ry,rx+rw,ry)||
        segI(x1,y1,x2,y2,rx,ry+rh,rx+rw,ry+rh);}
function segI(x1,y1,x2,y2,x3,y3,x4,y4){
 let d=(y4-y3)*(x2-x1)-(x4-x3)*(y2-y1);if(d===0)return!1;
 let ua=((x4-x3)*(y1-y3)-(y4-y3)*(x1-x3))/d,ub=((x2-x1)*(y1-y3)-(y2-y1)*(x1-x3))/d;return ua>=0&&ua<=1&&ub>=0&&ub<=1;
}

function doSlice(el){
 if(el.sliced||el.sliced===-1)return;
 el.sliced=true;
 el.halfs=[{type:'up',x:el.x,y:el.y,vx:-1.3,vy:-4.3,ay:0.14,imgSrc:el.imgSrc,word:el.word,alpha:1,angle:0,omega:-0.012},
           {type:'down',x:el.x,y:el.y,vx:1.3,vy:4.2,ay:0.11,imgSrc:el.imgSrc,word:el.word,alpha:1,angle:0,omega:0.012}];
 
 if(el.isCorrect && !caughtCorrect[el.word]){
  progress++;
  caughtCorrect[el.word]=true;
  playSound(sfxCorrect);
  animateProgress(false);
  setTimeout(trySpawnNew,240);
  checkFinishGame();
 }else{
  errors++;
  playSound(sfxWrong);
  animateProgress(true);
  setTimeout(trySpawnNew,240);
  checkErrorOver();
 }
}

function trySlicePath(){
 if(cursorPath.length<2)return;
 let prev=cursorPath[cursorPath.length-2],curr=cursorPath[cursorPath.length-1];
 for(let el of flyingElements)if(!el.sliced && fatLineRectIntersect(prev.x,prev.y,curr.x,curr.y,el.x,el.y,IMG_SIZE,IMG_SIZE)){
  doSlice(el);
 }
}
canvas.onmousedown=e=>{if(!gameStarted)return;sliceMode=true;cursorPath=[{x:e.clientX,y:e.clientY}];};
canvas.onmousemove=e=>{if(!gameStarted)return;if(sliceMode){cursorPath.push({x:e.clientX,y:e.clientY});if(cursorPath.length>8)cursorPath.shift();trySlicePath();}};
canvas.onmouseup=()=>{sliceMode=false;cursorPath=[];};
canvas.onmouseleave=()=>{sliceMode=false;cursorPath=[];};
canvas.onclick=e=>{
 if(!gameStarted)return;
 for(let el of flyingElements)if(!el.sliced && e.clientX>=el.x-14&&e.clientX<=el.x+IMG_SIZE+14 && e.clientY>=el.y-22&&e.clientY<=el.y+IMG_SIZE+22){
  doSlice(el);
 }
};

function checkFinishGame(){
 if(progress>=PROGRESS_COUNT&&!finished){
  finished=true;
  playSound(sfxVictory);
  document.getElementById('finish-message').innerHTML =
  `<div>Amazing! You popped all the Irregular Verbs!<br>Score: ${progress} / ${PROGRESS_COUNT}<br><button onclick="location.reload()">Play again?</button></div>`;
  document.getElementById('finish-message').style.display='block';
 }
}

function checkErrorOver(){
 if(errors>=ERROR_LIMIT&&!finished){
  finished=true;
  playSound(sfxGameOver);
  document.getElementById('finish-message').innerHTML =
    `<div><b>Game Over</b><br>Mistakes: ${errors}<br><button onclick="location.reload()">Restart</button></div>`;
  document.getElementById('finish-message').style.display='block';
 }
}

function animateProgress(miss=false){
 let percent=Math.max(0,Math.min(1,progress/PROGRESS_COUNT))*100,
      bar=document.getElementById('progress-bar');
 bar.style.width=percent+'%';
 if(miss){
   bar.classList.add("miss"); progressBarRedTimer=60;
 }
}
function updateStatusBar(){
 document.getElementById('status-bar').innerHTML = `<b>Score:</b> <b>${progress}</b> / ${PROGRESS_COUNT} &nbsp;&nbsp; <b>Mistakes:</b> <b>${errors}</b> / ${ERROR_LIMIT}`;
}
function drawCursorTrail(){
 if((!sliceMode&&sliceEffectTimer<=0)||cursorPath.length<2)return;
 ctx.save();ctx.lineJoin="round";ctx.lineCap="round";
 let color = "#aaffd8";
 for(let i=1;i<cursorPath.length;i++){
  let p0=cursorPath[i-1],p1=cursorPath[i],a=0.49+(i/cursorPath.length)*0.39;
  let cstr=`rgba(205,255,220,${a})`;
  ctx.strokeStyle=cstr;ctx.shadowBlur=13*(i/cursorPath.length);ctx.shadowColor=color;ctx.lineWidth=11-i/2;
  ctx.beginPath();ctx.moveTo(p0.x,p0.y);ctx.lineTo(p1.x,p1.y);ctx.stroke();
 }
 let last=cursorPath[cursorPath.length-1];
 ctx.shadowBlur=17;ctx.strokeStyle=color;
 ctx.beginPath();ctx.arc(last.x,last.y,10,0,2*Math.PI);ctx.stroke();ctx.restore();
 if(sliceEffectTimer>0){sliceEffectTimer--;}
}
function progressBarMissTimer(){
 if(progressBarRedTimer>0){
   progressBarRedTimer--;
   if(progressBarRedTimer===0){
     document.getElementById('progress-bar').classList.remove('miss');
   }else{
     setTimeout(progressBarMissTimer,16);
   }
 }
}
function gameLoop(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 if(gameStarted){
    drawElements();updateElements();
 }
 drawCursorTrail();updateStatusBar();
 if(gameStarted && !finished&&(flyingElements.filter(e=>!e.sliced).length<2)&&((wordCorrectQ.length>0||repeatCorrectQueue.length>0)||wordWrongQ.length>0)) setTimeout(trySpawnNew,210+Math.random()*180);
 if(progressBarRedTimer>0) progressBarMissTimer();
 requestAnimationFrame(gameLoop);
}
animateProgress();gameLoop();

function resetGameState(){
  _cw=correctWords.slice();
  _ww=wrongWords.slice();
  shuffle(_cw); shuffle(_ww);
  wordCorrectQ = _cw.map(w=>({word:w,isCorrect:true}));
  wordWrongQ   = _ww.map(w=>({word:w,isCorrect:false}));
  repeatCorrectQueue = [];
  caughtCorrect = {}; progress=0; errors=0; finished=false;
  pairWas = "none"; pairRepeat = 0;
  flyingElements=[];
  animateProgress();
}

function showOverlay(id){
  document.getElementById(id).style.display = "flex";
}
function hideOverlay(id){
  document.getElementById(id).style.display = "none";
}

function startGameWithCountdown(){
    hideOverlay('start-overlay');
    resetGameState();
    document.getElementById('finish-message').style.display='none';
   
    let cntDiv = document.getElementById('countdown');
    const countdownArr = ["3","2","1","LET'S GO!"];
    let step = 0;
    cntDiv.style.display = "block";
    function nextStep(){
        cntDiv.textContent = countdownArr[step];
        cntDiv.style.animation = 'none';
        void cntDiv.offsetWidth; 
        cntDiv.style.animation = null;
        step++;
        if(step < countdownArr.length){
            setTimeout(nextStep, step === 3 ? 900 : 800); 
        } else {
            setTimeout(()=>{
                cntDiv.style.display = "none";
                gameStarted=true;
                trySpawnNew();
            }, 900);
        }
    }
    step = 0;
    gameStarted = false;
    nextStep();
}

document.getElementById('start-btn').onclick = () => startGameWithCountdown();
window.addEventListener('load',()=> {
    showOverlay('start-overlay');
});
</script>
</body>
</html>